{% load bread_tags crispy_forms_utils  %}

{% specialspaceless %}
<div class="card-panel col s12">
<h5>
{% if formset.max_num > 1 %}
    {% pretty_modelname formset.model True %}
{% else %}
    {% pretty_modelname formset.model %}
{% endif %}
</h5>

{% include "materialize/errors_formset.html" %}
<table id="formset_{{ formset.prefix }}_table">
    {{ formset.management_form }}

    {% if form.non_field_errors %}
        {% for non_field_error in form.non_field_errors %}
             {{ non_field_error }}
        {% endfor %}
    {% endif %}

    <tbody>
    {% for form in formset %}
        {% if not form.is_extra %}
            {% include "materialize/errors.html" %}
        {% endif %}

        <tr>
            {% for field in form.hidden_fields %}
                {% include 'materialize/field.html' %}
            {% endfor %}
            {% for field in form.visible_fields %}
            <td>
                {% include 'materialize/field.html' %}
            </td>
            {% endfor %}
        </tr>
    {% endfor %}
    </tbody>
    <tfoot>
        <tr>
            <td>
                <a id="add_{{ formset.prefix }}_button" class="btn waves-effect" onclick="formset_{{ formset.prefix }}_add();">Add {% pretty_modelname formset.model %}</a>
            </td>
        </tr>
    </tfoot>
</table>

<!-- template form to insert new entry when clicking add-button -->
<div id="empty_{{ formset.prefix }}_form" style="display:none;" class="template-form">
    <table>
        <tr>
            {% for field in formset.empty_form.hidden_fields %}
                {% include 'materialize/field.html' %}
            {% endfor %}
            {% for field in formset.empty_form.visible_fields %}
            <td>
                {% include 'materialize/field.html' %}
            </td>
            {% endfor %}
        </tr>
    </table>
</div>

<script>
    // TODO: refactoring: make functions generic (not formset.prefix depending)
    // TODO: maybe move to external javascript
    // TODO: maybe use bliss
    // TODO: nicer "remove" functionality (disable fields and gray out, or hide column)
    function init_{{ formset.prefix }}_formset() {
        var m_input_fields  = $$('#empty_{{ formset.prefix }}_form .input-field')
        for(var j = 0; j < m_input_fields.length; ++j) {
            $("input, select", m_input_fields[j]).classList.add('no-autoinit');
        }
        update_add_{{ formset.prefix }}_button();
    }
    function enable_materialize_newform(form) {
        var m_input_fields = form.getElementsByClassName("input-field");
        for(var j = 0; j < m_input_fields.length; ++j) {
            $("input, select", m_input_fields[j]).classList.remove('no-autoinit');
        }
        M.Datepicker.init(form.querySelectorAll('.datepicker'), {format: 'yyyy-mm-dd', showClearBtn: true, autoClose: true});
        M.AutoInit(form);
    }
    function update_add_{{ formset.prefix }}_button() {
        var formcount = $('#id_{{ formset.prefix }}-TOTAL_FORMS')
        var maxforms = $('#id_{{ formset.prefix }}-MAX_NUM_FORMS')
        var addbutton = $('#add_{{ formset.prefix }}_button')
        addbutton.style.display = "inline-block";
        if(parseInt(formcount.value) >= parseInt(maxforms.value)) {
            addbutton.style.display = "none";
        }
    }
    function formset_{{ formset.prefix }}_add() {
        var formcount = $('#id_{{ formset.prefix }}-TOTAL_FORMS')
        var newElementStr = $('#empty_{{ formset.prefix }}_form').innerHTML.replace(/__prefix__/g, formcount.value)
		var newElem = new DOMParser().parseFromString(newElementStr, "text/html").getElementsByTagName('tr')[0];
        $('#formset_{{ formset.prefix }}_table tbody').appendChild(newElem);
        formcount.value = parseInt(formcount.value) + 1;
        enable_materialize_newform(newElem);
        update_add_{{ formset.prefix }}_button();
    }
    function formset_{{ formset.prefix }}_remove() {
    }
    document.addEventListener("DOMContentLoaded", e => init_{{ formset.prefix }}_formset());
</script>
</div>
{% endspecialspaceless %}
